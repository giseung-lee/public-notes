<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Microservices with Spring Cloud 5 - Spring Cloud Hystrix, Bus &middot; 이기승의 끄적끄적..
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
<link rel="stylesheet" href="/public/css/ntz4kiseung.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- Profile -->
  <div class="sidebar-item sidebar-profile-box">
    <img class="sidebar-profile-image" src="/public/image/About Me/sidebar_profile.png" >
    <div class="sidebar-profile-description">
      <span>
        &nbsp;잡기에 능한 개발자입니다. 잡기보다 개발 실력이 좋아야 할 텐데 걱정입니다.
      </span>
    </div>
  </div>
  <!-- Profile End -->

  <nav class="sidebar-nav">
    <!-- Home -->
    <a class="sidebar-nav-item" href="/">Home</a>
    <!-- Home End -->
    <!-- Posts -->
    
    
      
        <!-- 1 depth post -->
        <a class="sidebar-nav-item" href="http://localhost:4000/posts/About Me">About Me</a>
      
    
      
        <!-- 1 depth post -->
        <a class="sidebar-nav-item" href="http://localhost:4000/posts/Daily Thoughts">Daily Thoughts</a>
      
    
      
        <input id="Projects" class="toggle" type="checkbox">
        <label for="Projects" class="lbl-toggle sidebar-nav-item" tabindex="0">Projects</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Sagyo_Reboot">Sagyo_Reboot</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Twitch_Chat_Analysis">Twitch_Chat_Analysis</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Hwangmaesan">Hwangmaesan</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/The_Oyster_Mine">The_Oyster_Mine</a>
          
        
        </div>
      
    
      
        <input id="Study" class="toggle" type="checkbox">
        <label for="Study" class="lbl-toggle sidebar-nav-item" tabindex="0">Study</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/Http The Definitive Guide">Http The Definitive Guide</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/C_Kim_Pope">C_Kim_Pope</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/MSA_Ken_Krueger">MSA_Ken_Krueger</a>
          
        
        </div>
      
    
      
        <input id="Googling" class="toggle" type="checkbox">
        <label for="Googling" class="lbl-toggle sidebar-nav-item" tabindex="0">Googling</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/etc">etc</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/java">java</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/jekyll">jekyll</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/linux">linux</a>
          
        
        </div>
      
    
    <!-- Posts End -->
  </nav>

  <!-- sidebar bottom -->
  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
  <!-- sidebar bottom end -->
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title" style="font-weight: normal;">
            <a href="/" title="Home">이기승의 끄적끄적..</a>
            <small>개발 및 잡다한 포스팅</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Microservices with Spring Cloud 5 - Spring Cloud Hystrix, Bus</h1>
  <span class="post-date">25 Apr 2020</span>
  
<ul>
  <li>본 포스팅은 Ken Krueger 선생님의 <a href="https://www.udemy.com/course/microservices-with-spring-cloud/">Microservices with Spring Cloud</a> 강의를 정리하며 사견을 붙인 것입니다.</li>
  <li>포스팅 내 목차는 개별 동영상 강의 기준입니다.</li>
</ul>

<h2 id="21-spring-cloud-hystrix---circuit-breaker">21. Spring Cloud Hystrix - Circuit Breaker</h2>

<hr />

<ul>
  <li>Hystrix 역시 클라이언트단 기술입니다.</li>
</ul>

<h3 id="211-학습목표">21.1. 학습목표</h3>

<ul>
  <li>어떻게 서킷 브레이커가 cascade failure로 부터 애플리케이션을 보호하는지 이해합니다.</li>
  <li>Spring Cloud Netflix Hystrix를 사용해 서킷 브레이커를 구현해봅시다.</li>
  <li>Hytrix Dashboard와 Turbine을 이용해 서킷 브레이커를 모니터링 하는 방법을 알아봅시다.</li>
</ul>

<h3 id="212-cascading-failure-and-the-circuit-breaker-solution">21.2. Cascading Failure and the Circuit Breaker Solution</h3>

<ul>
  <li>Cascading failure란 복잡하게 얽혀있는 네트워크, 시스템에서 한 부분의 고장이 연관된 다른 부분들을 고장을 연쇄하는 것을 말합니다. MSA는 기본적으로 여러 서비스들이 서로 얽혀 통신하기 때문에 대비를 하지 않으면 cascading failure에 매우 취약합니다.</li>
  <li>이런 failure의 연쇄를 끊기 위해 도입된 것이 Circuit Breaker Pattern 입니다.</li>
  <li>누전 차단기를 생각하면 쉽습니다.(원래 circuit breaker가 물리적인 회로 차단기입니다.)
    <ul>
      <li>누전 차단기는 전기 회로를 감시하고 있습니다.</li>
      <li>회로에 너무 많은 전기가 흐르면(프로그래밍에선 오류가 나면) 누전 차단기가 스스로 회로를 열어서 전기를 차단합니다.</li>
      <li>문제를 해결한 뒤에 사람이 다시 회로를 닫으면 전기가 흐르며 정상적으로 작동합니다.</li>
    </ul>
  </li>
</ul>

<h3 id="213-using-spring-cloud-netflix-hystrix">21.3. Using Spring Cloud Netflix Hystrix</h3>

<ul>
  <li>
    <p>Hystrix는 Netflix OSS의 하나였고 현재는 Spring Cloud에서 wrapper api를 제공합니다.</p>
  </li>
  <li>
    <p>Hysytrix는 어플리케이션의 요청이 failure 되는걸 감시하고 있습니다. 일정 기준을 정해두고 그 이상 failure가 감지되면 “open” 하여 더 이상의 요청이 발생하지 않도록 합니다.</p>

    <ul>
      <li>기본 값은 5초안에 20 failure로 셋팅되어 있고 개발자가 따로 설정할 수 있습니다.</li>
    </ul>
  </li>
  <li>
    <p>open 했을 때 어떻게 행동해야 할지 fallback을 설정할 수 있습니다.</p>

    <ul>
      <li>캐시된 이전 요청을 쓰거나, 에러 메세지를 보내거나 등을 할 수 있습니다.</li>
    </ul>
  </li>
  <li>
    <p>open된 후 일정 시간 이후 close를 시도합니다. (운영자가 직접 닫을 필요가 없습니다!)</p>

    <ul>
      <li>기본 값은 5초입니다. 역시 설정할 수 있습니다.</li>
    </ul>
  </li>
  <li>
    <p>사용방법은 지금까지 했던 다른 기술들과 유사합니다.</p>

    <ul>
      <li>
        <p>의존성을 추가하고</p>

        <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>application에 <code class="highlighter-rouge">@EnalbeHystrix</code>를 추가합니다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableHystrix</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>각 요청들에 <code class="highlighter-rouge">@HystrixCommand</code>를 설정해 서킷 브레이커 발생시 행동 및 기타 옵션을 정해줍니다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordServiceImpl</span> <span class="kd">implements</span> <span class="nc">WordService</span> <span class="o">{</span>
    <span class="c1">// getNoun에서 서킷 브레이커 발생시 getFallbackNoun 메서드로 가겠다. </span>
	<span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span><span class="o">=</span><span class="s">"getFallbackNoun"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">Word</span> <span class="nf">getNoun</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">nounClient</span><span class="o">.</span><span class="na">getWord</span><span class="o">();</span>
	<span class="o">}</span>	
	<span class="kd">public</span> <span class="nc">Word</span> <span class="nf">getFallbackNoun</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Word</span><span class="o">(</span><span class="s">"something"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p><code class="highlighter-rouge">@HystrixCommand</code> 작성시 아래와 같은 <code class="highlighter-rouge">commandProperties = {@HystrixPropery...}</code>를 설정하면 옵션을 정해줄 수 있습니다. properties에 대한 상세사항은 <a href="https://github.com/Netflix/Hystrix/wiki/Configuration#CommandCircuitBreaker">여기</a>를 참고해주세요.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HystrixCommand</span><span class="o">(</span>
	<span class="n">fallbackMethod</span><span class="o">=</span><span class="s">"getFallbackNoun"</span><span class="o">,</span>
	<span class="n">commandProperties</span> <span class="o">=</span> <span class="o">{</span>
		<span class="nd">@HystrixPropery</span><span class="o">(</span>
			<span class="n">name</span><span class="o">=</span><span class="s">"circuitBreaker.errorThresholdPercentage"</span><span class="o">,</span>
			<span class="n">value</span><span class="o">=</span><span class="s">"20"</span>
			<span class="o">),</span>
		<span class="nd">@HystrixPropery</span><span class="o">(</span>
			<span class="n">name</span><span class="o">=</span><span class="s">"circuitBreaker.sleepWindowInMilliseconds"</span><span class="o">,</span>
			<span class="n">value</span><span class="o">=</span><span class="s">"1000"</span>
		<span class="o">)</span>
	<span class="o">}</span>	
<span class="o">)</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>HystrixCommand는 다양하게 사용가능합니다.</p>

    <ul>
      <li>
        <p>Synchronously - 기본적으론 동기식으로 작동합니다. call을 하고 쓰레드는 대기합니다.</p>
      </li>
      <li>
        <p>Asynchronously - 비동기식으로 작동할 수도 있습니다. call을 부르고 기다리는 동안 다른 쓰레드를 작업할 수 있습니다. 리턴 타입을 바꾸기만 하면 비동기식으로 바꿀 수 있습니다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HystrixCommand</span><span class="o">(...)</span>
<span class="kd">public</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Store</span><span class="o">&gt;</span> <span class="nf">getStore</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">){</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nc">AsyncResult</span><span class="o">&lt;</span><span class="nc">Store</span><span class="o">&gt;(){</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">Store</span> <span class="nf">invoke</span><span class="o">(){</span>
			<span class="c1">// do something..</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Reactively - listener를 통해 따로 추가명령이 없어도 call에서 응답이오면 처리 가능합니다.(??) Reactive 하게 만드는 것 역시 리턴 타입만 바꿔주면 됩니다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HystrixCommand</span><span class="o">(...)</span>
<span class="kd">public</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="nc">Store</span><span class="o">&gt;</span> <span class="nf">getStore</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">){</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nc">ObservableResult</span><span class="o">&lt;</span><span class="nc">Store</span><span class="o">&gt;(){</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">Store</span> <span class="nf">invoke</span><span class="o">(){</span>
			<span class="c1">// do something..</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="214-hystrix-dashboard-and-turbine">21.4. Hystrix Dashboard and Turbine</h3>

<ul>
  <li>Hystrix Dashboard는 서킷 브레이커들의 상태를 시각적으로 보여줍니다.</li>
</ul>

<p class="p_img"><img src="/public/image/MSA_Ken_Krueger/hystrix_dashboard.png" alt="hystrix_dashboard.png" /><small>출처 : https://cloud.spring.io/spring-cloud-netflix/multi/multi__circuit_breaker_hystrix_dashboard.html</small></p>

<ul>
  <li>
    <p>사용하고 싶다면 의존성을 추가하고, application에 <code class="highlighter-rouge">asd</code>를 추가해줍니다.</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableHystrix</span>
<span class="nd">@EnableHystrixDashboard</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>설정이 됐다면 http://{host}:{port}/hystrix 에서 볼 수 있습니다.</p>
  </li>
  <li>
    <p>서비스가 커져서 Dashboard만으로 관리하기 힘들어지면 Turbine을 알아보세요.</p>
  </li>
</ul>

<h2 id="22-lab-7---hystrix">22. Lab 7 - Hystrix</h2>

<hr />

<ul>
  <li>Hystrix 실습</li>
</ul>

<h2 id="23-spring-cloud-bus---dynamic-configuration-changes">23. Spring Cloud Bus - Dynamic Configuration Changes</h2>

<hr />

<ul>
  <li>Spring Cloud Bus는 서비스들이 실행 중에 설정이 바뀌면 바뀐 설정을 서비스들에게 알려주는 기술입니다.</li>
</ul>

<h3 id="231-학습목표">23.1. 학습목표</h3>

<ul>
  <li>(Spring Cloud Bus 없이) 동적으로 설정을 업데이트 하는 것의 문제점을 알아봅니다.</li>
  <li>Spring Cloud Bus에 대해 알아봅니다.</li>
  <li>Refresh가 어떻게 동작하는지 알아봅시다.</li>
</ul>

<h3 id="232-어플리케이셔-실행-중-설정-업데이트">23.2. 어플리케이셔 실행 중 설정 업데이트</h3>

<ul>
  <li>Sprinc Cloud Config를 다시 떠올려 봅시다.
    <ul>
      <li>중앙화 된 설정 서버가 설정 파일들을 클라이언트에게 줍니다.</li>
      <li>설정 파일 자체는 원격지에서 버전 컨트롤, 소스 컨트롤 될 수 있습니다.</li>
      <li>Config 클라이언트는 시작 될 때만 Config 서버에서 설정 파일을 받아옵니다.</li>
    </ul>
  </li>
  <li>근데, 클라이언트들이 실행 된 후에 설정 파일이 바뀌면 어떻게 될까요?
    <ul>
      <li>이전에 사용하던 방식은 연관된 어플리케이션들을 “Bounce” 하는 것입니다. 쉽게 말해 다시 시작합니다.</li>
      <li>다른 방식으론 주기적으로 Config 서버에 요청을 보내는 방법이 있습니다. 하지만, 설정 파일이 언제 업데이트 될 진 모릅니다. 낭비가 심합니다.</li>
      <li>Spring Cloud Bus는 설정 파일을 Config 서버가 클라이언트에게 푸쉬 하는 방식으로 작동합니다. AMQP 같은 메세징으로 전송이 됩니다.</li>
    </ul>
  </li>
</ul>

<h3 id="233-spring-cloud-bus">23.3. Spring Cloud Bus</h3>

<ul>
  <li>
    <p>Bus는 Config 서버에서 설정 파일의 변경을 클라이언트에게 알려주는 방식으로 동작합니다.</p>
  </li>
  <li>
    <p>메세징 기술에 기반합니다. (현재는 AMQP 프로토콜만 사용합니다.)</p>
  </li>
  <li>
    <p>사용방법 다음과 같습니다.</p>

    <ul>
      <li>
        <p>의존성을 Config 서버, 클라이언트 모두 동일하게 추가해줍니다.</p>

        <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-bus-amqp<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>AMQP 서버를 실행해줍니다. 강의에선 Rabbit MQ를 사용합니다.</p>

        <ul>
          <li>AMQP 서버는 Config 서버의 변경된 설정 파일을 받아 클라이언트에게 뿌려주는 중개자 역할을 합니다.</li>
          <li>Config 서버와 클라이언트 모두 알아서 AMQP 서버와 통신합니다.</li>
        </ul>
      </li>
      <li>
        <p>설정 파일이 바뀌면 Config 서버에 (수동으로) <code class="highlighter-rouge">POST /bus/refresh</code> 요청을 보내줍니다.</p>
      </li>
      <li>
        <p>요청을 받은 Config 서버는 AMQP 서버에 변경된 설정 파일을 보내냅니다.</p>
      </li>
      <li>
        <p>AMQP 서버는 받은 설정 파일을 클라리언트들에게 뿌려줍니다.</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="234-how-refresh-work">23.4. How Refresh Work</h3>

<ul>
  <li>Spring Boot 어플리케이션은 실행중에 refresh 할 수 있습니다.</li>
  <li>Spring Boot 어플리케이션엔 Actuator 라는게 있습니다. 각종 endpoint를 제공해주는 컴포넌트입니다. Eureka에서 Eureka 서버에게 클라이언트가 살아있음을 주기적으로 보낼 때도 Actuator를 사용했습니다.</li>
  <li>Actuator에서 <code class="highlighter-rouge">/refresh</code>라는 endpoint를 제공합니다.
    <ul>
      <li>org.springframework.boot와 spring-boot-actuator 가 있어야 합니다.</li>
    </ul>
  </li>
  <li>하지만 refresh 하는 일은 어플리케이션 내의 모든 컴포넌트가 실행 할 수 있을만큼 간단한 일은 아닙니다. 따라서 다음과 같은 컴포넌트들만 refresh 하게 됩니다.
    <ul>
      <li><code class="highlighter-rouge">@ConfigurationProperties</code> 또는 <code class="highlighter-rouge">@RefreshScope</code>가 붙은 빈</li>
      <li>로깅</li>
    </ul>
  </li>
</ul>

<h3 id="235-configurationproperties">23.5. @ConfigurationProperties</h3>

<ul>
  <li>
    <p><code class="highlighter-rouge">@ConfigurationProperties</code> 는 새로운 어노테이션은 아닙니다. Spring Boot에 포함된 어노테이션입니다. <code class="highlighter-rouge">@ConfigurationProperties</code> 어노테이션은 <code class="highlighter-rouge">@Value</code> 어노테이션을 여러 개 붙여야 할 때 간편하게 한 번에 붙일 수 있게해줍니다. 아래와 같이 씁니다.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">"wordConfig"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LuckyWordController</span> <span class="o">{</span>
  
	<span class="nc">String</span> <span class="n">luckyWord</span><span class="o">;</span>
	<span class="nc">String</span> <span class="n">preamble</span><span class="o">;</span>
  	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/lucky-word"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">showLuckyWord</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">preamble</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">luckyWord</span><span class="o">;</span>
	<span class="o">}</span>
  	
	<span class="cm">/* luckWord, preamble Getter/Setter */</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">\---</span>
<span class="na">wordConfig</span><span class="pi">:</span>
  <span class="na">lucky-word</span><span class="pi">:</span> <span class="s">Irish</span>
  <span class="na">preamble</span><span class="pi">:</span> <span class="s">The lucky word is</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>‘relaxed binding’ 이란 것도 제공하는데, ‘lucky-word’를 찾을때 ‘LuckyWord’, ‘LUCKY_WORD’ 같은 것도 같이 찾아줍니다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">@ConfigurationProperties</code> 으로 찾아진 property들은 refresh 될 때 새로운 값으로 rebound 됩니다.</p>
  </li>
  <li>
    <p>하지만 <code class="highlighter-rouge">@ConfigurationProperties</code> 는 새로운 property를 rebound만 시켜주고, 이를 적용하기 위해선 해당 bean을 다시 초기화해야 합니다.</p>
  </li>
</ul>

<h3 id="236-refreshscope">23.6. @RefreshScope</h3>

<ul>
  <li>
    <p><code class="highlighter-rouge">@RefreshScope</code>는 Spring Cloud에서 등장한 것입니다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">@ConfigurationProperties</code>는 property를 rebound만 시켰다면, <code class="highlighter-rouge">@RefreshScope</code>는 한 bean 단위로 property를 rebound 하고 bean을 안전하게 reloading 해줍니다.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RefreshScope</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LuckyWordController</span> <span class="o">{</span>
  
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${wordConfig.lucky-word}"</span><span class="o">)</span><span class="nc">String</span> <span class="n">luckyWord</span><span class="o">;</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${wordConfig.preamble}"</span><span class="o">)</span><span class="nc">String</span> <span class="n">preamble</span><span class="o">;</span>
  	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/lucky-word"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">showLuckyWord</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">preamble</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">luckyWord</span><span class="o">;</span>
	<span class="o">}</span>
  	
	<span class="cm">/* luckWord, preamble Getter/Setter */</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="highlighter-rouge">@RefreshScope</code>는 Proxy 패턴을 기반으로 작동합니다.</p>

    <ul>
      <li>Bean이 자체로 만들어지지 않고 Proxy Bean이 만들어지고 그 안에 원래 Bean injection 됩니다.</li>
      <li>Proxy Bean이 refresh를 하면 Proxy Bean은 계속 살아 있으면서 기본에 injection된 Bean과의 관계를 끊고 새로운 설정으로 만들어진 Bean을 다시 injection 합니다.</li>
    </ul>
  </li>
</ul>

<h2 id="24-lab-8---spring-cloud-bus">24. Lab 8 - Spring Cloud Bus</h2>

<hr />

<ul>
  <li>Spring Cloud Bus 실습</li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/study/msa_ken_krueger/MSA6/">
            Microservices with Spring Cloud 6 - API Gateway (Zuul)
            <small>25 Apr 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/study/msa_ken_krueger/MSA4/">
            Microservices with Spring Cloud 4 - Spring Cloud Eureka, Ribbon, Feign
            <small>25 Apr 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/study/c_kim_pope/C4/">
            C Unmanaged Programming 4 - 포인터 (작성중)
            <small>25 Apr 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
