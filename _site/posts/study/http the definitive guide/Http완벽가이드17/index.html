<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      HTTP 17 - 내용 협상과 트랜스코딩 &middot; 이기승의 끄적끄적..
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
<link rel="stylesheet" href="/public/css/ntz4kiseung.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <!-- Profile -->
  <div class="sidebar-item sidebar-profile-box">
    <img class="sidebar-profile-image" src="/public/image/About Me/sidebar_profile.png" >
    <div class="sidebar-profile-description">
      <span>
        &nbsp;잡기에 능한 개발자입니다. 잡기보다 개발 실력이 좋아야 할 텐데 걱정입니다.
      </span>
    </div>
  </div>
  <!-- Profile End -->

  <nav class="sidebar-nav">
    <!-- Home -->
    <a class="sidebar-nav-item" href="/">Home</a>
    <!-- Home End -->
    <!-- Posts -->
    
    
      
        <!-- 1 depth post -->
        <a class="sidebar-nav-item" href="http://localhost:4000/posts/About Me">About Me</a>
      
    
      
        <!-- 1 depth post -->
        <a class="sidebar-nav-item" href="http://localhost:4000/posts/Daily Thoughts">Daily Thoughts</a>
      
    
      
        <input id="Projects" class="toggle" type="checkbox">
        <label for="Projects" class="lbl-toggle sidebar-nav-item" tabindex="0">Projects</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Sagyo_Reboot">Sagyo_Reboot</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Twitch_Chat_Analysis">Twitch_Chat_Analysis</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/Hwangmaesan">Hwangmaesan</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Projects/The_Oyster_Mine">The_Oyster_Mine</a>
          
        
        </div>
      
    
      
        <input id="Study" class="toggle" type="checkbox">
        <label for="Study" class="lbl-toggle sidebar-nav-item" tabindex="0">Study</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/Http The Definitive Guide">Http The Definitive Guide</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/C_Kim_Pope">C_Kim_Pope</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Study/MSA_Ken_Krueger">MSA_Ken_Krueger</a>
          
        
        </div>
      
    
      
        <input id="Googling" class="toggle" type="checkbox">
        <label for="Googling" class="lbl-toggle sidebar-nav-item" tabindex="0">Googling</label>
        <div class="collapsible-content subcategories">
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/etc">etc</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/java">java</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/jekyll">jekyll</a>
          
        
          
            <!-- 2 depth post -->
            <a class="sidebar-nav-item" href="http://localhost:4000/posts/Googling/linux">linux</a>
          
        
        </div>
      
    
    <!-- Posts End -->
  </nav>

  <!-- sidebar bottom -->
  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
  <!-- sidebar bottom end -->
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title" style="font-weight: normal;">
            <a href="/" title="Home">이기승의 끄적끄적..</a>
            <small>개발 및 잡다한 포스팅</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">HTTP 17 - 내용 협상과 트랜스코딩</h1>
  <span class="post-date">27 Mar 2020</span>
  
<h3 id="들어가며">들어가며</h3>

<hr />

<ul>
  <li>사용 언어 별로 다른 문서를 주거나, 브라우저별로 다른 자바스크립트를 주어야 하는 등 하나의 URL이 여러 리소스에 대응되야 할 때가 있습니다.</li>
  <li>이때, 어떤 리소스를 받을 지 클라이언트와 서버가 협상할 수 있습니다. 이를 내용 협상이라고 합니다.</li>
  <li>한편, 내용 협상 결과로 주어야할 리소스가 이미 존재하는 경우도 있지만 동적으로 생성해야 할 때도 있습니다. 이를 트랜스 코딩이라고 합니다.</li>
</ul>

<h3 id="171-내용-협상-기법">17.1. 내용 협상 기법</h3>

<hr />

<ul>
  <li>내용 협상이란 하나의 URL이 여러 리소스에 대응될 때, 어떤 리소스가 적절한 리소스인지 클라이언트와 서버가 정하는 방법입니다.</li>
  <li>내용 협상엔 크게 세 가지 방법이 존재 합니다.
    <ul>
      <li>클라이언트 주도 : 서버가 클라이언트에게 선택지를 제공하면 클라이언트가 선택합니다. 서버에서 구현이 쉽고 클라이언트가 가장 원하는 선택을 할 수 있지만 리소스를 얻기위한 대기시간(단계)가 증가합니다.</li>
      <li>서버 주도 : 클라이언트의 요청헤더를 바탕으로 서버가 리소스를 결정합니다. 클라이언트 주도 협상보다 빠르지만 클라이언트가 원하는 리소스가 없다면 서버가 추측을 해야 하는 상황이 발생합니다.</li>
      <li>투명 : 투명한 중간 장치(주로 프록시 캐시)가 서버를 대신해 협상합니다. 서버의 부하가 줄어드는게 장점이지만 투명 협상에 대한 명세가 없습니다.</li>
    </ul>
  </li>
</ul>

<h3 id="172-클라이언트-주도-협상">17.2. 클라이언트 주도 협상</h3>

<hr />

<ul>
  <li>서버가 선택 가능한 선택지들을 클라이언트에게 돌려주고 사용자가 직접 선택합니다. 그 방법엔 두 가지가 있습니다.
    <ul>
      <li>여러 버전에 대한 링크와 설명이 담긴 HTML 페이지를 돌려줄 수 있습니다.</li>
      <li>300 Multiple Choices 응답 코드로 HTTP/1.1 응답을 돌려줍니다.</li>
    </ul>
  </li>
  <li>서버 입장에선 가장 구현하기 쉽습니다.</li>
  <li>클라이언트는 가능한 선택지 안에서 최선의 선택을 할 수 있습니다.</li>
  <li>단점은 목록을 보여주고 요청을 다시 받기 때문에 리소스를 받는 과정이 길어집니다.</li>
  <li>또 다른 단점으론 리소스당 여러 url이 필요합니다.
    <ul>
      <li>영어페이지, 프랑스어 페이지가 존재하는 www.joes-hardware.com를 요청하면 www.joes-hardware.com/english와 www.joes-hardware.com/french 둘을 준비해야 합니다.</li>
    </ul>
  </li>
</ul>

<h3 id="173-서버-주도-협상">17.3. 서버 주도 협상</h3>

<hr />

<ul>
  <li>서버 주도 협상은 클라이언트가 선호하는 옵션을 같이 요청합니다.
    <ul>
      <li>Accept 관련 헤더인 내용 협상 헤더를 사용합니다.</li>
      <li>User-Agent와 같은 내용 협상 헤더 외 다른 헤더를 사용합니다.</li>
    </ul>
  </li>
  <li>서버는 위 헤더들을 파악해 클라이언트가 원하는 리소스를 돌려줍니다.</li>
</ul>

<h4 id="1731-내용-협상-헤더">17.3.1. 내용 협상 헤더</h4>

<ul>
  <li>
    <p>내용 협상 헤더엔 아래와 같은 것들이 있습니다.</p>

    <table>
      <thead>
        <tr>
          <th>헤더</th>
          <th>설명</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Accept</td>
          <td>서버가 어떤 미디어 타입으로 보내도 되는지 알려줍니다.</td>
        </tr>
        <tr>
          <td>Accept-Language</td>
          <td>서버가 어떤 언어로 보내도 되는지 알려줍니다.</td>
        </tr>
        <tr>
          <td>Accept-Charset</td>
          <td>서버가 어떤 charset으로 보내도 되는지 알려줍니다.</td>
        </tr>
        <tr>
          <td>Accept-Encoding</td>
          <td>서버가 어떤 인코딩으로 보내도 되는지 알려줍니다.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>앞 장들에서 살펴본 Content로 시작하는 엔터티 헤더와 각각 대응됩니다.</p>
  </li>
  <li>
    <p>클라이언트는 매 요청마다 선호 정보를 다시 보내야 합니다.(HTTP는 Stateless 하기 때문입니다.)</p>
  </li>
  <li>
    <p>각 헤더엔 1개의 선호가 아니라 여러 선호를 담을 수 있습니다.</p>

    <ul>
      <li>Accept-Language : ko, en, fr</li>
      <li>이때, 각 선호에 quality value (앞으로 q값이라 칭함)를 주어 선호의 정도를 나타낼 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h4 id="1732-내용-협상-헤더의-품질값quality-value-q값">17.3.2. 내용 협상 헤더의 품질값(quality value, q값)</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Accept-Language : en;q=0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0
</code></pre></div></div>

<ul>
  <li>0.0은 선호하지 않음, 1.0은 가장 선호함입니다.</li>
  <li>위 헤더는 프랑스어(fr), 터키어(tr)는 원하지 않고 영어(en)는 받아들일 수 있으며 네더란드어(nl)를 가장 선호한다는 뜻입니다.</li>
  <li>한편, 서버에 클라이언트가 선호하는 버전이 없을 수 있습니다. 이 때 서버는 기본 문서를 주거나 클라이언트의 선호에 맞추기 위해 트랜스코딩을 할 수 있습니다.</li>
</ul>

<h4 id="1733-그-외의-헤더들에-의해-결정">17.3.3. 그 외의 헤더들에 의해 결정</h4>

<ul>
  <li>브라우저의 종류와 같이 리소스별로 따로 관리해야 하지만 내용 협상 헤더엔 담길 수 없는 것들이 있습니다.</li>
  <li>이땐 User-Agent와 같은 내용 협상 헤더 외의 헤더를 사용할 수 있습니다.</li>
  <li>이 헤더들에선 q값을 사용할 수 없습니다.</li>
  <li>한편, 캐시를 이용하기 위해 Vary 헤더를 이용하기도 합니다.
    <ul>
      <li>Vary 헤더는 서버가 응답시에 추가하는 헤더입니다.</li>
      <li>Vary 헤더는 서버가 어떤 요청 헤더를 참고하고 해당 리소스를 응답해줬는지 말해줍니다.</li>
      <li>캐시가 요청을 받는 상황이라면 Vary헤더를 통해 클라이언트의 요청에 맞춰 캐시된 리소스를 돌려줄 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h4 id="1734-아파치의-내용-협상">17.3.4. 아파치의 내용 협상</h4>

<ul>
  <li>
    <p>많이 사용되는 웹 서버인 아파치에서 내용 협상을 구현하기 위해선 각 버전에 해당하는 파일을 적절한 디렉터리에 넣어줘야 합니다.</p>
  </li>
  <li>
    <p>그 후 아래 둘 중 하나의 방법으로 내용 협상을 진행할 수 있습니다.</p>

    <p><strong>type-map 파일 사용하기</strong></p>

    <ul>
      <li>
        <p>type-map 파일은 내용 협상 헤더의 내용과 협상 결과 돌려줘야할 리소스를 맵핑해줍니다.</p>
      </li>
      <li>
        <p>type-map 파일을 사용하기 위해선 우선 서버 설정 파일에 type-map 파일들을 위한 설정을 해야 합니다.</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AddHandler type-map .var
</code></pre></div>        </div>
      </li>
      <li>
        <p>위 설정은 .var 확장자를 가진 파일들이 type-map임을 뜻합니다.</p>
      </li>
      <li>
        <p>type-map 파일은 다음과 같이 이루어져 있습니다.</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>URI: joes-hardware.html
    
URI: joes-hardware.en.html
Content-type: text/html
Content-language: en
    
URI: joes-hardware.fr.de.html
Content-type: text/html;charset=iso-8859-2
Content-language: fr, de 
</code></pre></div>        </div>
      </li>
      <li>
        <p>위와 같이 구성하면 아파치가 내용 협상 헤더를 읽어 적절한 콘텐츠로 맵핑해줍니다.</p>
      </li>
    </ul>

    <p><strong>MultiViews 사용하기</strong></p>

    <ul>
      <li>MultiViews는 아파치에서 사용자가 설정해 놓은 디렉터리 구조에 맞게 type-map 파일을 생성하도록 하는 지시어입니다.</li>
      <li>MultiViews를 사용하기 위해선 access.conf 파일에서 Options 지시어를 이용해 설정해 놓은 디렉터리에 MultiViews 옵션을 활성화시켜야 합니다.</li>
    </ul>
  </li>
  <li>
    <p>아파치서버의 내용 협상에 대한 더 자세한 사항은 <a href="https://httpd.apache.org/docs/2.4/content-negotiation.html">https://httpd.apache.org/docs/2.4/content-negotiation.html</a>를 참고하면 좋을 것 같습니다.</p>
  </li>
</ul>

<h4 id="1735-서버-측-확장">17.3.5. 서버 측 확장</h4>

<ul>
  <li>서버 주도 협상의 다른 방법으로 ASP 와 같은 서버 측 확장을 하는 방법도 있습니다.</li>
  <li>이는 8장에서 다뤄보았었습니다.</li>
</ul>

<h3 id="174-투명-협상">17.4. 투명 협상</h3>

<hr />

<ul>
  <li>투명 협상은 캐시 프록시에서 진행되는 협상입니다.</li>
  <li>투명 협상을 이용하면 클라이언트와 메세지 교환 횟수(클라이언트 측 협상의 단점)를 줄이는 동시에 서버의 부하(서버 측 협상의 단점)를 막을 수 있습니다.</li>
  <li>프록시가 내용 협상을 하기 위해선 클라이언트의 요청 중 어느 헤더를 살펴봐야하는 지를 알아야 합니다.</li>
  <li>이를 위해 서버는 캐시 프록시에게 Vary 헤더를 포함시킨 응답을 줍니다. 프록시는 Vary헤더를 통해 어떤 헤더를 검사해야 하는 지 알 수 있습니다.</li>
</ul>

<h4 id="1741-캐시와-얼터네이트alternate">17.4.1. 캐시와 얼터네이트(alternate)</h4>

<ul>
  <li>캐시 안 같은 문서에 대해 영어버전 문서, 프랑스어 버전 문서가 있다고 가정합시다.</li>
  <li>이 다른 버전을 배리언트(variant) 혹은 얼터네이트(alternate)라고 부릅니다.</li>
</ul>

<h4 id="1742-vary-헤더">17.4.2. Vary 헤더</h4>

<ul>
  <li>캐시는 여러 얼터네이트중 올바른 문서를 클라이언트에게 돌려주어야 합니다.</li>
  <li>올바른 문서를 찾기 위해선 어떤 조건에서(어떤 헤더를 보고) 서버가 해당 문서를 돌려주었는지 알아야 합니다.</li>
  <li>이를 알려주는게 Vary 헤더입니다. 서버는 내용 협상결과 문서를 돌려줄때 Vary 헤더에 자신이 검사한 헤더를 나열해줍니다.</li>
  <li>캐시는 클라이언트의 요청이 왔을때 Vary 헤더에 있는 헤더들을 검사해 맞는 얼터네이트를 찾습니다.</li>
</ul>

<p><img src="/public/image/Http The Definitive Guide/vary_header.png" alt="vary_header.png" /></p>

<ul>
  <li>위 그림은 캐시된 아파치 문서를 가져올때 어떤 헤더들을 고려했는지를 보여줍니다.</li>
</ul>

<h3 id="175-트랜스코딩">17.5. 트랜스코딩</h3>

<hr />

<ul>
  <li>지금까지의 내용 협상은 방법이 어찌됐든 협상 결과 돌려줄 문서가 이미 존재해야 했습니다.</li>
  <li>하지만 모든 웹 페이지들이 한국어 버전을 준비해놓지는 않는 것 처럼, 클라이언트가 요청한 버전의 문서가 없을 수도 있습니다.</li>
  <li>이럴땐 기존의 문서를 클라이언트의 요청에 맞게 바꾸는 트랜스코딩 과정을 거칠 수 있습니다.</li>
  <li>아래는 트랜스코딩의 예시입니다.
    <ul>
      <li>HTML문서 → WML문서</li>
      <li>고해상도 이미지 → 저해상도 이미지</li>
      <li>64K색 이미지 → 흑백 이미지</li>
      <li>프레임, 이미지 등을 포함한 복잡한 페이지 → 프레임, 이미지 등이 없는 단순 텍스트 페이지</li>
      <li>자바 애플릿이 있는 HTML 페이지 → 자바 애플릿이 없는 페이지</li>
      <li>광고가 있는 페이지 → 광고가 없는 페이지</li>
    </ul>
  </li>
  <li>트랜스코딩엔 크게 아래 세 가지가 있습니다.
    <ul>
      <li>포맷 변환</li>
      <li>정보 합성</li>
      <li>콘텐츠 주입</li>
    </ul>
  </li>
</ul>

<h4 id="1751-포맷-변환">17.5.1. 포맷 변환</h4>

<ul>
  <li>포맷 변환은 말 그대로 컨텐츠의 포맷을 바꾸어주는 것입니다.</li>
  <li>HTML 페이지를 WML 페이지로 바꾸는 것 등이 포맷 변환 트랜스 코딩의 예시 입니다.</li>
  <li>포맷 변환은 주로 내용 협상 헤더에 의해 주도됩니다.</li>
</ul>

<h4 id="1752-정보-합성information-synthesis">17.5.2. 정보 합성(information synthesis)</h4>

<ul>
  <li>정보 합성은 한 문서에서 정보의 요점들을 추출하는 것을 말합니다.</li>
  <li>문서에서 각 절의 제목에 기반해 요약된 문서를 만드는 등이 그 예시입니다.</li>
  <li>각 문서들의 주요 키워드를 뽑아 페이지들을 분류하는 등 포털 사이드에서도 종종 쓰입니다.</li>
</ul>

<h4 id="1753-콘텐츠-주입">17.5.3. 콘텐츠 주입</h4>

<ul>
  <li>광고가 없는 페이지에 광고를 삽입하는 등의 콘텐츠 주입 역시 트랜스 코딩의 한 예시입니다.</li>
</ul>

<h4 id="1754-트랜스코딩-vs-정적으로-미리-생성해놓기">17.5.4. 트랜스코딩 vs 정적으로 미리 생성해놓기</h4>

<ul>
  <li>그렇다면 한 가지 의문이 생길 수 있습니다.</li>
  <li>트랜스코딩으로 만들어 질 수 있는 콘텐츠들을 미리 생성해 두면 응답 시간을 더 줄일 수 있지 않을까 하는 의문입니다.</li>
  <li>물론, 서버가 넉넉하다면 그럴 수 있겠지만 모든 서버에는 비용에 제약이 있습니다.</li>
  <li>트랜스코딩이 될 수 있는 모든 콘텐츠를 미리 생성해 놓는 것은 서버의 공간을 낭비하게 됩니다.(특히 자주 안쓰이는 콘텐츠라면 더욱더)</li>
  <li>또한 미리 생성해 놓는 방식은 원본 콘텐츠가 조금이라도 변경되면 모든 얼터네이트들을 다시 생성해야 합니다.</li>
  <li>한편, 트랜스코딩은 서버 외부의 프록시 등에서도 이루어질 수 있기 때문에 자주 요청되는 문서가 아니라면 트랜스 코딩을 통해 서버의 부하를 줄이고 서버를 효율적으로 운용할 수 있게 됩니다.</li>
</ul>

<h3 id="마치며">마치며</h3>

<hr />


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/study/msa_ken_krueger/MSA2/">
            Microservices with Spring Cloud 2 - Modern Spring - Spring Boot, Spring Data, and Spring Data REST
            <small>22 Apr 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/study/msa_ken_krueger/MSA1/">
            Microservices with Spring Cloud 1 - Introduction to Microservices
            <small>21 Apr 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/study/c_kim_pope/C2/">
            C Unmanaged Programming 2 - C언어 기본 문법1
            <small>21 Apr 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
