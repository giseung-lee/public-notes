---
layout: post
title: HTTP 20 - 리다이렉션과 부하 균형
---
{% assign imgurl=site.data.common.path.image|append: '/'|append: page.categories[1] %}

### 들어가며

---

- 이번 장에선 리다이렉션에 대해 알아보겠습니다.
- 다음과 같은 것들에 대해 배웁니다.
  - HTTP 리다이렉션
  - DNS 리다이렉션
  - 임의 캐스트 라우팅
  - 정책 라우팅
  - 아이피 맥 포워딩
  - 아이피 주소 포워딩
  - 웹 캐시 조직 프로토콜(WCCP)
  - 인터캐시 커뮤니케이션 프로토콜(ICP)
  - 하이퍼텍스트 캐싱 프로토콜(HTCP)
  - 네트워크 요소 제어 프로토콜(NECP)
  - 캐시 배열 라우팅 프로토콜(CARP)
  - 웹 프록시 자동발견 프로토콜(WPAD)



### 20.1. 왜 리다이렉트인가?

---

- 현대의 웹은 항상 다음과 같은 사항들을 요구합니다.
  - 신뢰할 수 있는 HTTP 트랜잭션
  - 지연 최소화
  - 네트워크 대역폭 절약
- 위 사항들을 만족시키려면 콘텐츠의 분산이 필수적입니다. 그리고 그에 따라 리다이렉션도 현대 웹의 필수 사항이 됐습니다.
- 이런 리다이렉션을 구현하기 위해선 부하균형(Load Balancing, 앞으로 로드밸런싱이라 부름)에 관한 문제를 고민해봐야 합니다.



### 20.2. 리다이렉트 할 곳

---

- 서버, 프록시, 캐시, 게이트웨이 모두 리다이렉션을 할수 있고, 리다이렉션의 대상이 될 수 있습니다.
- 웹 서버로의 리다이렉션은 보통 한 요청에 대해 가장 빠르게 응답할 수 있는 곳으로 보낼때 사용합니다.
- 프록시에서의 리다이렉션은 보통 트래픽의 주 진입로 중간에 끼어 빠른 길을 찾아주고자 할때(캐시 처럼)사용합니다.



### 20.3. 리다이렉션 프로토콜의 개요

---

- 리다이렉션의 궁극적인 목표는 HTTP 트랜잭션을 빠르게 만드는 것입니다.
- 리다이렉션되는 HTTP 메세지들은 많은 HTTP 애플리케이션(서버, 프록시 등)과 네트워크 장치(스위치, 라우터 등)에 영향을 받습니다.
- 대부분의 리다이렉션 기법들이 어떤 서버, 프록시에서든 가능하지만 몇몇 리다이렉션 기법(브라우저에서 프록시 설정하는 것 등)은 프록시로 향하는 리다이렉션에서만 작동합니다.
  - 20.4에선 일반적인 리다이렉션 방법을 알아보고
  - 20.5에선 프록시에서만 사용되는 리다이렉션을 알아보겠습니다.



### 20.4. 일반적인 리다이렉션 방법

---

- 이 절에선 서버, 프록시 양쪽에서 모두 쓰일 수 있는 일반적인 리다이렉션 방법을 알아볼 것입니다.
- 다음과 같은 방법을 알아봅니다.
  - HTTP 리다이렉션
  - DNS 리다이렉션
  - 애니캐스트 어드레싱 (책엔 '임의 캐스트(Anycast)'라고 되어 있으나 애니캐스트라고 부르겠습니다.)
  - 아이피 맥 포워딩
  - 아이피 주소 포워딩

#### 20.4.1. HTTP 리다이렉션

- HTTP 리다이렉션이란 한 요청에 대해 302 Redirect 코드와 Location헤더 응답으로 리다이렉션 시키는 것입니다.

- 다음은 HTTP 리다이렉션의 예입니다.

  - A가 B에게 요청을 보냅니다. Host 헤더는 도메인명입니다.

    ```
    GET /hammers.html HTTP/1.0
    Host: www.joes-hardware.com
    User-Agent: Mozilla/4.51 [en] (X11; U; IRIX 6.2 IP22) 
    ```

  - B(www.joes-hardware.com)는 분산된 서버중에 가장 빠른 서버를 찾아주는 서버였고 다음과 같은 응답을 돌려 줍니다. 응답은 C서버(161.58.228.45)로 리다이렉션 시키는 응답입니다.

    ```
    HTTP/1.0 302 Redirect
    Server: Stronghold/2.4.2 Apache/1.3.6
    Location: http://161.58.228.45/hammers.html 
    ```

  - A는 B의 응답의 Location 헤더를 읽고 Location 헤더에 있는 ip 주소를 요청의 Host 헤더에 넣습니다.

    ```
    GET /hammers.html HTTP/1.0
    Host: 161.58.228.45
    User-Agent: Mozilla/4.51 [en] (X11; U; IRIX 6.2 IP22) 
    ```

  - C서버(161.58.228.45)는 A의 요청에 대해 맞는 리소스를 돌려주게 됩니다.

- HTTP 리다이렉션의 장점은 다음과 같습니다.

  - 리다이렉션을 시키는 서버가 클라이언트의 IP 주소등의 정보를 알고 있습니다.
  - 클라이언트의 정보에 근거해 최적의 서버를 찾아줄 수 있습니다.

- HTTP 리다이렉션의 단점은 다음과 같습니다.

  - 리다이렉션을 해주는 서버에 많은 부하가 걸립니다.
  - 요청할 때마다 두 번의 왕복이 필요합니다.
  - 리다이렉션을 해주는 서버가 고장나면 다른 서버를 이용할 수 없습니다.

- 단점도 많기 때문에 보통 다른 리다이렉션 기법과 같이 사용합니다.

#### 20.4.2. DNS 리다이렉션

- www.joes-hardware.com 같은 도메인을 받으면 이를 IP로 변환해주는 작업이 필요합니다.

- 이를 수행해주는 것이 DNS Resolver 입니다.

- DNS Resolver는 클라이언트의 운영체제, 클라이언트의 DNS 서버, 원격의 DNS 서버 등 다양합니다.

- 한편, 하나의 도메인은 여러 IP를 갖을 수 있습니다.

  - 이때 DNS Resolver는 IP의 목록을 보여줍니다.

  - 아래는 윈도우 콘솔을 이용해 www.youtube.com의 IP 목록을 찾은 것입니다.

    ```c
    C:\Users\Kiseung>nslookup www.youtube.com
    서버:    bns1.hananet.net
    Address:  210.220.163.82
    
    권한 없는 응답:
    이름:    youtube-ui.l.google.com
    Addresses:  2404:6800:4004:81f::200e
              172.217.27.78
              172.217.26.14
              172.217.174.110
              216.58.197.142
              172.217.175.46
              172.217.25.78
              216.58.220.142
              172.217.26.46
              172.217.31.174
              172.217.161.78
              172.217.25.110
              216.58.197.238
              172.217.161.46
              172.217.31.142
              172.217.25.206
              172.217.24.142
    Aliases:  www.youtube.com
    ```

  - 위에서 ```서버:    bns1.hananet.net``` 는 제가 사용하고 있는 DNS 서버입니다.  DNS 서버가 다르다면 조회한 IP 목록이 다를 수 있습니다.

- 이런 여러 IP중 하나를 선택하는 방법은 매우 다양합니다.

- 여러 IP들이 부하를 골고루 받도록 하는 방법을 로드 밸런싱이라고 합니다.

**DNS 라운드 로빈**

- 라운드 로빈은 로드밸런싱의 가장 간단한 방법입니다.
- 라운드 로빈은 여러 개의 서버에 순서대로 부하를 주는 방법입니다.

**다중 주소와 라운드 로빈 주소 순환**

- 대부분 DNS 클라이언트는 받아온 IP 목록 중 첫번째 IP를 사용합니다.

- 이때, DNS 서버는 로드밸런싱을 위해 DNS 클라이언트에게 IP 목록을 돌려주고나서 IP목록을 순환시켜 줍니다. 

- 아래와 같이 www.youtube.com의 IP 목록을 조회할 때 마다 IP들의 순서가 바뀌는 것을 볼수 있습니다.

  ```
  이름:    youtube-ui.l.google.com
  Addresses:  2404:6800:4004:81f::200e
            172.217.27.78
            172.217.26.14
            :
  ```

  ```
  이름:    youtube-ui.l.google.com
  Addresses:  2404:6800:4004:813::200e
            172.217.25.110
            172.217.175.110
            :
  ```

  ```
  이름:    youtube-ui.l.google.com
  Addresses:  2404:6800:4004:81d::200e
            172.217.175.14
            216.58.197.142
            :
  ```

**DNS 캐싱의 효과**

- 라운드 로빈은 합리적인 것 같지만 DNS 캐시를 생각해보면 얘기가 달라집니다.
- 콘텐츠들을 캐싱하는 것 처럼 DNS 조회 결과 역시 캐시할 수 있습니다.
- 이때 캐시된 DNS를 사용한다면, 한 클라이언트는 계속 같은 IP를 사용할 것입니다.

**다른 DNS 기반 리다이렉션 알고리즘**

- 단순한 라운드 로빈 방식이 아닌 다른 방식으로 여러 IP중 하나를 고르기도 합니다.
  - 로드 밸런싱 알고리즘 : DNS 서버가 대상 웹 서버들의 로드를 추적해 가장 로드가 적은 서버를 IP목록의 제일 위에 놓습니다.
  - 근접 라우팅(Proximity-routing) 알고리즘 : 대상 웹 서버들이 지리적으로 분산되어 있는 경우, 클라이언트와 지리적으로 인접한 웹 서버를 찾습니다.
  - 결함 마스킹 알고리즘(Fault-masking) : DNS 서버가 네트워크의 상태를 모니터링하며 장애가 없고 빠른 네트워크로 라우팅 시킵니다.

#### 20.4.3. 임의캐스트(Anycast) 어드레싱

#### 20.4.4. 아이피 맥 포워딩

#### 20.4.5. 아이피 주소 포워딩

#### 20.4.6. 네트워크 구성요소 제어 프로토콜



### 20.5. 프록시 리다이렉션 방법

---

- 앞서 본 것은 일반적인 리다이렉션 방법이었습니다.
- 한편, 프록시에서만 사용되는 리다이렉션 방법들이 있는데 그 대표적인 예가 브라우저에서 프록시를 설정하는  것입니다.
- 브라우저에서 프록시를 설정하는 방법은 크게 세 가지가 있습니다.
  - 명시적 설정
  - 동적 설정
  - 웹 프록시 자동발견

#### 20.5.1. 명시적 브라우저 설정

- 대부분의 브라우저에선 수동으로 프록시를 설정할 수 있습니다. 

![proxy1.png]({{ imgurl }}/proxy1.png)

![proxy2.png]({{ imgurl }}/proxy2.png)

- 수동으로 프록시를 설정하는 방법은 다음과 같은 한계가 있습니다.
  - 설정한 프록시에 장애가 생기면 통신이 불가능합니다.
  - 네트워크 아키텍처가 변경되면 모든 사용자에게 전파해야 하고, 모든 사용자들은 재설정을 해야합니다.

#### 20.5.2. 프록시 자동 설정

- 명시적으로 프록시의 주소를 설정하는 것보다 좋은 방법은 프록시의 정보를 갖고있는 URL을 지정하는 것입니다.
- 이런 방법을 프록시 자동설정(Proxy Auto-configuration, PAC) 프로토콜이라고 합니다.
- 이 방법은 PAC 파일이라는 불리는 특별한 파일의 URL을 각 브라우저에 설정하는 것입니다.
  - PAC 파일은 ```function FindProxyForURL(url ,host)``` 를 구현하는 js 파일입니다.
  - PAC 파일은 요청 URL 별로 접촉해야할 프록시를 맵핑해둔 파일입니다.
  - PAC 파일에 대한 자세한 사항은 [http://findproxyforurl.com/](http://findproxyforurl.com/) 를 참조해주세요.
  - PAC 파일을 찾은 브라우저는 ```FindProxyForURL``` 함수를 호출해 프록시의 주소를 받아옵니다.
- 브라우저가 시작될 때 PAC 파일을 찾아옵니다.
- 네트워크 아키텍처의 변경시엔 PAC 파일을 수정하면 사용자들은 자동으로 수정된 프록시의 주소를 찾아갈 수 있습니다.

![proxy3.png]({{ imgurl }}/proxy3.png)

- PAC 파일의 URL을 위의 스크립트 주소에 입력하면 됩니다.

#### 20.5.3. 웹 프록시 자동발견 프로토콜(Web Proxy Autodiscovery Protocol)

- 한편, 이 PAC 주소조차 설정 안해도 되는 방법이 있습니다.
- 웹 프록시 자동발견 프로토콜(Web Proxy AutoDiscovery, WPAD)이 이를 가능하게 해줍니다.
- WPAD는 웹 브라우저가 근처의 프록시를 찾도록 도와줍니다.

**PAC 파일 자동 발견**

- WPAD는 우선 PAC 파일을 자동으로 찾아줍니다.(어떻게 찾는 지는 뒤에서 소개합니다.)

  - PAC 파일자체를 가져오는건 아니고 PAC 파일의 CURL (Client URL) 을 찾습니다.

  - WPAD가 직접 프록시의 주소를 찾진 않습니다.
  - WPAD가 직접 프록시의 주소를 찾으면 PAC파일이 제공하는 부가기능(로드밸런싱, 장애 대처 등)을 사용할 수 없기 때문입니다.

- 브라우저에서 PAC 파일의 URL을 통해 PAC 파일을 가져옵니다.

- PAC 파일을 실행해 요청할 URL에 맞는 프록시 주소를 가져옵니다.

**WPAD 알고리즘**

- 그렇다면 WPAD는 어떻게 PAC 파일의 URL을 알아올까요?
- WPAD는 아래의 방법으로 PAC파일의 URL을 가져올 수 있습니다.
  - DHCP(Dynamic Host Configuration Protocol, 동적 호스팅 설정 프로토콜)
  - SLP(Service Location Protocol, 서비스 위치 프로토콜)
  - DNS A(Alias) 레코드 룩업(== DNS에게 잘 알려진 호스트명)
  - DNS SRV(Service) 레코드 룩업
  - DNS TXT 레코드 룩업(TXT 레코드의 DNS 서비스 URL들)
- WPAD는 위 방법들중 DHCP, SLP를 순서대로 먼저 수행합니다.
- DHCP, SLP로 PAC 파일의 URL을 찾지 못했다면 아래 3가지 룩업을 여러 차례 순환합니다.
- 그래도 PAC 파일 URL을 찾지 못했다면 프록시를 사용하지 않고 요청을 보냅니다.
- WPAD의 더 자세한 사항은 [명세](https://tools.ietf.org/html/draft-ietf-wrec-wpad-01)를 참고해주세요.

**DHCP를 이용한 CURL 발견**

- DHCP로 PAC 파일의 URL을 찾는 과정은 아래와 같습니다.

  ![wpad_dhcp.png]({{ imgurl }}/wpad_dhcp.png "https://findproxyforurl.com/wpad-introduction/")

  - WPAD 클라이언트가 DHCP 서버로 DHCPINFORM 메세지를 보내 PAC 파일의 CURL을 물어봅니다.

  - DHCP 서버가 PAC 파일의 CURL을 발견했다면 DHCP ACK 메시지로 응답합니다.

    - DHCP ACK 메세지엔 '252'라는 옵션이 있는데 찾은 CURL이 252 옵션에 들어 있습니다.

      ```
      252="http://company.com/proxy.pac"
      ```

**DNS A(alias) 룩업**

- DNS A 룩업은 'DNS에게 잘 알려진 호스트 명'이라고도 합니다.
- 입력받은 도메인과 정확히 일치하지 않더라도 DNS가 가지고 있는 호스트의 별칭을 통해 PAC 파일의 CURL을 찾는 과정입니다.

**PAC 파일 가져오기**

- WPAD가 PAC 파일의 CURL을 갖게된다면, 그 CURL로 GET 요청을 보냅니다.
- 요청의 결과가 리다이렉트라면, 리다이렉트의 주소가 클라이언트가 가야할 최종목적지 입니다.

**언제 WPAD를 실행하는가**

- WPAD는 다음과 같은 상황에서 실행될 수 있습니다.
  - 웹 클라이언트가 시작될 때 WPAD가 실행될 수 있습니다.
  - 갖고 있는 PAC 파일이 만료됐을때 WPAD 프로세스가 다시 진행될 수도 있습니다.
    - 단, If-Modified-Since 같은 조건부 요청은 지원하지 않습니다.(캐시의 신선도 검사와 다름 주의)
  - 현재 PAC 파일로 얻어온 프록시에 장애가 있고 현재 PAC 파일이 다른 대안을 제시해주지 않을때 WPAD로 다른 PAC 파일을 찾을 수도 있습니다.

**WPAD 스푸핑(spoofing, 속이다)**

- WPAD 알고리즘은 다음과 같이 작동합니다.
  - 요청 도메인 : a.b.microsoft.com
  - 도메인에 'wpad' 를 붙여 WPAD 서버를 찾아봅니다 : wpad.a.b.microsoft.com
  - 3차 도메인에 도달할 때 까지 서브 도메인을 지우고 WPAD 서버를 찾는걸 반복합니다.
    - 1) wpad.b.microsoft.com
    - 2) wpad.microsoft.com
- 이런 알고리즘은 보안에 취약할 수 있습니다. 
  - 악의적인 사용자가 서브 도메인이 지워질걸 예상하고 wpad.b.microsoft.com을 선점해 악의적인 프록시를 설치할 수 있기 때문입니다.

**타임아웃**

- WPAD가 거치는 각 단계엔 타임아웃이 존재합니다.

**관리자를 위한 고려사항**

- 추후 기술



### 20.6. 캐시 리다이렉션 방법

---

- 프록시 중 캐시 프록시를 위해 사용되는 리다이렉션은 더욱 복잡합니다.

#### 20.6.1. WCCP 리다이렉션



### 20.7. 인터넷 캐시 프로토콜

---



### 20.8. 캐시 배열 라우팅 프로토콜

---



### 20.9. 하이퍼텍스트 캐싱 프로토콜

---

#### 20.9.1. HTCP 인증

#### 20.9.2. 캐싱 정책 설정





### 마치며 

---

- 목차에 있는 키워드들은 어느정도 익숙한 키워드가 많아 어렵지 않게 읽을 수 있을 것 같았는데 세부적으로 생소한 개념들이 많이 고전중입니다.. 씁..